<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moeda Maker</title>
  <script>
    // Enable class-based dark mode for Tailwind CDN
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <!-- Safe (Gnosis) Apps SDK & Provider UMD builds -->
  <script src="https://unpkg.com/@safe-global/safe-apps-sdk@9.1.0/dist/safe-apps-sdk.umd.min.js"></script>
  <script src="https://unpkg.com/@safe-global/safe-apps-provider@0.17.1/dist/safe-apps-provider.umd.min.js"></script>
  <!-- Optional WalletConnect provider for Rainbow/mobile wallets -->
  <!-- WalletConnect provider (local copy, pinned version) -->
  <script src="vendor/walletconnect-ethereum-provider/index.umd.js"></script>
  <script>
    // Bridge UMD namespace to a simpler global for easier detection
    (function(){
      var ns = window['@walletconnect/ethereum-provider'];
      if (ns && !window.WalletConnectEthereumProvider) {
        var E = ns.EthereumProvider || ns.default || ns;
        if (E) {
          window.WalletConnectEthereumProvider = E;
        }
      }
      // Expose Safe Apps SDK/Provider globals in a predictable way
      if (!window.SafeAppsSDK && window.safeAppsSDK) {
        window.SafeAppsSDK = window.safeAppsSDK;
      }
      if (!window.SafeAppsProvider && window.safeAppsProvider) {
        window.SafeAppsProvider = window.safeAppsProvider;
      }
    })();
  </script>
  <!-- Optional env overrides for static hosting: create public/env.js from env.example.js -->
  <script src="env.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 via-white to-slate-100 dark:from-slate-900 dark:via-slate-950 dark:to-slate-900 text-slate-900 dark:text-slate-100">
  <div id="root"></div>

  <script>
    (function () {
      try {
        var base = window.API_BASE || (location && location.origin ? location.origin : '');
        if (base && typeof axios !== 'undefined') {
          axios.defaults.baseURL = base;
        }
        // Detect Safe App context early and attach provider for EIP-1193 compatibility
        (async function initSafe() {
          try {
            if (!window.SafeAppsSDK) return;
            const sdk = new window.SafeAppsSDK();
            // If not in Safe, getInfo will throw
            const info = await sdk.safe.getInfo();
            window.IS_SAFE_APP = true;
            window.SAFE_INFO = info;
            // Attach Safe provider to window.ethereum so generic flows work
            if (window.SafeAppsProvider) {
              const safeProvider = new window.SafeAppsProvider(sdk);
              window.ethereum = safeProvider;
            }
            // Optionally broadcast an event so UI can react
            window.dispatchEvent(new CustomEvent('safe:ready', { detail: info }));
          } catch (_) {
            window.IS_SAFE_APP = false;
          }
        })();
      } catch (e) {}
    })();
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Simple wallet connector inspired by RainbowKit flow
    // - Browser wallets via window.ethereum
    // - Rainbow/Mobile via WalletConnect v2 (QR modal)
    function WalletConnection() {
      const [address, setAddress] = useState(null);
      const [connecting, setConnecting] = useState(false);
      const [error, setError] = useState(null);
      const [isContract, setIsContract] = useState(false);
      const [providerType, setProviderType] = useState(null); // 'browser' | 'walletconnect' | 'safe'
      const providerRef = React.useRef(null);

      useEffect(() => {
        const saved = sessionStorage.getItem('connectedAddress');
        if (saved) setAddress(saved);
        // If running inside Safe, prefer Safe address
        if (window.IS_SAFE_APP && window.SAFE_INFO?.safeAddress) {
          setAddress(window.SAFE_INFO.safeAddress);
          setIsContract(true);
          setProviderType('safe');
        }
      }, []);

      useEffect(() => {
        if (address) sessionStorage.setItem('connectedAddress', address);
        window.CONNECTED_ADDRESS = address || null;
        window.dispatchEvent(new CustomEvent('wallet:changed', { detail: { address } }));
      }, [address]);

      async function checkIsContract(addr, providerLike) {
        try {
          if (!addr || !providerLike) return setIsContract(false);
          const code = await providerLike.request({ method: 'eth_getCode', params: [addr, 'latest'] });
          setIsContract(code && code !== '0x');
        } catch (_) { setIsContract(false); }
      }

      async function ensureWCEthereumProvider() {
        const adoptNs = () => {
          const ns = window['@walletconnect/ethereum-provider'];
          if (ns) {
            const E = ns.EthereumProvider || ns.default || ns;
            if (E && typeof E.init === 'function') {
              // normalize shape to always have an init function
              return { init: (opts) => E.init(opts) };
            }
          }
          return undefined;
        };

        // 1) Already present global
        if (window.WalletConnectEthereumProvider && typeof window.WalletConnectEthereumProvider.init === 'function') {
          return window.WalletConnectEthereumProvider;
        }

        // 2) UMD namespace export
        let viaNs = adoptNs();
        if (viaNs) return viaNs;

        // 3) Try loading from CDN, then poll briefly in case of delayed availability
        await new Promise((resolve) => {
          if (document.getElementById('wc-eth-provider-cdn')) return resolve();
          const s = document.createElement('script');
          s.id = 'wc-eth-provider-cdn';
          s.src = 'https://unpkg.com/@walletconnect/ethereum-provider@2.11.1/dist/index.umd.js';
          s.async = true;
          s.onload = resolve;
          s.onerror = resolve; // resolve anyway; we'll re-check
          document.head.appendChild(s);
        });

        // quick retries (up to ~1s)
        for (let i = 0; i < 10; i++) {
          if (window.WalletConnectEthereumProvider && typeof window.WalletConnectEthereumProvider.init === 'function') {
            return window.WalletConnectEthereumProvider;
          }
          viaNs = adoptNs();
          if (viaNs) return viaNs;
          await new Promise(r => setTimeout(r, 100));
        }
        return undefined;
      }

      function clearWalletConnectStorage() {
        try {
          const patterns = [/walletconnect/i, /wc@2/i, /WALLETCONNECT/i];
          const lsKeys = Object.keys(localStorage || {});
          for (const k of lsKeys) {
            if (patterns.some((p) => p.test(k))) localStorage.removeItem(k);
          }
          const ssKeys = Object.keys(sessionStorage || {});
          for (const k of ssKeys) {
            if (patterns.some((p) => p.test(k))) sessionStorage.removeItem(k);
          }
        } catch (_) {}
      }

      async function connectRainbowWC() {
        const projectId = window.WC_PROJECT_ID || (window.ENV && window.ENV.WC_PROJECT_ID);
        if (!projectId) { setError('Missing WalletConnect projectId. Set window.WC_PROJECT_ID.'); return; }
        const Provider = await ensureWCEthereumProvider();
        if (!Provider || !Provider.init) { setError('WalletConnect provider not loaded'); return; }
        setConnecting(true); setError(null);
        try {
          // Ensure no previous WC session forces auto-reconnect
          clearWalletConnectStorage();
          const provider = await Provider.init({
            projectId,
            showQrModal: true,
            chains: [1],
            optionalChains: [137, 44787, 42220],
            metadata: {
              name: 'Moeda Maker',
              description: 'Bank-backed tokens and WhatsApp onboarding',
              url: (location && location.origin) || 'http://localhost',
              icons: ['https://walletconnect.com/walletconnect-logo.png']
            }
          });
          // Enable session (RainbowKit internally triggers connect through wagmi)
          let accounts = [];
          try {
            accounts = await provider.enable();
          } catch (_) {
            // Some builds prefer explicit request
            accounts = await provider.request({ method: 'eth_requestAccounts' });
          }
          const addr = accounts?.[0];
          setAddress(addr);
          await checkIsContract(addr, provider);
          providerRef.current = provider;
          setProviderType('walletconnect');
          // Handle provider-led disconnects
          try { provider.on && provider.on('disconnect', () => handleDisconnect()); } catch (_) {}
        } catch (e) { setError(e?.message || 'WalletConnect failed'); }
        finally { setConnecting(false); }
      }

      async function connectBrowserWallet() {
        const target = window.ethereum;
        if (!target) { setError('No browser wallet found'); return; }
        setConnecting(true); setError(null);
        try {
          // Best-effort revoke to avoid silent reuse; some wallets ignore
          try { await target.request({ method: 'wallet_revokePermissions', params: [{ eth_accounts: {} }] }); } catch (_) {}
          try { await target.request({ method: 'wallet_requestPermissions', params: [{ eth_accounts: {} }] }); } catch (_) {}
          const accounts = await target.request({ method: 'eth_requestAccounts' });
          const addr = accounts?.[0];
          setAddress(addr);
          await checkIsContract(addr, target);
          providerRef.current = target;
          setProviderType('browser');
          // Listen for account changes and disconnects
          try {
            target.on && target.on('accountsChanged', (accs) => {
              const a = accs && accs[0];
              if (!a) { handleDisconnect(); } else { setAddress(a); }
            });
            target.on && target.on('disconnect', () => handleDisconnect());
          } catch (_) {}
        } catch (e) { setError(e?.message || 'Browser wallet connect failed'); }
        finally { setConnecting(false); }
      }

      async function handleDisconnect() {
        try {
          const p = providerRef.current;
          // Attempt provider-specific disconnects first (WalletConnect v2)
          if (p && typeof p.disconnect === 'function') {
            try { await p.disconnect(); } catch (_) {}
          }
          if (p && typeof p.disconnectSession === 'function') {
            try { await p.disconnectSession(); } catch (_) {}
          }
          // For injected providers, revoke permissions to force fresh prompt next time
          try {
            if (providerType === 'browser' && p && typeof p.request === 'function') {
              await p.request({ method: 'wallet_revokePermissions', params: [{ eth_accounts: {} }] });
            }
          } catch (_) {}
          // Remove listeners (best-effort)
          try { p && p.removeListener && p.removeListener('accountsChanged', () => {}); } catch (_) {}
          try { p && p.removeListener && p.removeListener('disconnect', () => {}); } catch (_) {}
        } catch (_) {}
        // Proactively clear WC session caches to avoid auto-reconnect
        clearWalletConnectStorage();
        providerRef.current = null;
        setProviderType(null);
        setIsContract(false);
        setAddress(null);
        sessionStorage.removeItem('connectedAddress');
        sessionStorage.removeItem('preferredProviderUUID');
        window.CONNECTED_ADDRESS = null;
        window.dispatchEvent(new CustomEvent('wallet:changed', { detail: { address: null } }));
      }

      if (address) {
        return (
          <div className="flex items-center gap-2">
            <span className={`px-2 py-1 rounded text-xs ${isContract ? 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-200' : 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200'}`}
                  title={window.IS_SAFE_APP ? 'Safe App (multisig)' : (isContract ? 'This looks like a contract wallet (e.g., multisig)' : 'EOA')}>
              {window.IS_SAFE_APP ? 'Safe' : (isContract ? 'Contract' : 'EOA')}
            </span>
            <span className="text-xs font-mono">{address.slice(0,6)}…{address.slice(-4)}</span>
            {!window.IS_SAFE_APP && (
              <button onClick={handleDisconnect}
                      className="ml-2 px-2 py-1 rounded bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 text-xs hover:bg-slate-300 dark:hover:bg-slate-600">
                Disconnect
              </button>
            )}
          </div>
        );
      }

      return (
        <div className="flex items-center gap-2">
          {!window.IS_SAFE_APP && (
          <button onClick={connectBrowserWallet} disabled={connecting}
                  className="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs hover:bg-blue-700 shadow">
            {connecting ? 'Connecting…' : 'Connect Multisig'}
          </button>)}
          {window.IS_SAFE_APP && (
            <span className="text-xs text-green-600">Safe App detected</span>
          )}
          {error && <span className="text-xs text-red-600 dark:text-red-300">{error}</span>}
        </div>
      );
    }

    const NavItem = ({ label, icon, active, onClick }) => (
      <button onClick={onClick} className={`flex items-center w-full px-3 py-2 rounded-lg text-sm transition shadow-sm ${active ? 'bg-blue-600 text-white' : 'text-slate-700 dark:text-slate-200 hover:bg-slate-100/70 dark:hover:bg-slate-800/50'}`}>
        <span className="mr-2">{icon}</span>{label}
      </button>
    );

    function App() {
      const [active, setActive] = useState('dashboard');
      const [notice, setNotice] = useState(null);
      // Auto-dismiss notices after 3 seconds
      useEffect(() => {
        if (!notice) return;
        const t = setTimeout(() => setNotice(null), 3000);
        return () => clearTimeout(t);
      }, [notice]);

      return (
        <div className="min-h-screen">
          <div className="relative overflow-hidden">
            <div className="absolute inset-0 -z-10 opacity-60 dark:opacity-30">
              <div className="absolute -top-24 -left-24 h-72 w-72 rounded-full bg-blue-300/30 blur-3xl"></div>
              <div className="absolute -bottom-24 -right-24 h-72 w-72 rounded-full bg-emerald-300/30 blur-3xl"></div>
            </div>
            <header className="backdrop-blur bg-white/70 dark:bg-slate-900/50 border-b border-white/40 dark:border-slate-800">
              <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-600 to-emerald-500 text-white grid place-items-center font-semibold shadow">PC</div>
                  <div>
                    <h1 className="font-semibold text-slate-900 dark:text-slate-100">Moeda Maker</h1>
                    <p className="text-xs text-slate-500 dark:text-slate-400">Bank-backed tokens • WhatsApp onboarding</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <WalletConnection />
                  <div className="hidden sm:flex items-center text-xs text-green-600"><span className="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Online</div>
                </div>
              </div>
            </header>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-6 grid grid-cols-12 gap-6">
            <aside className="col-span-12 md:col-span-3 lg:col-span-2">
              <div className="backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl p-2 space-y-1 shadow-sm">
                <NavItem label="Dashboard" icon="🏠" active={active==='dashboard'} onClick={() => setActive('dashboard')} />
                <NavItem label="Make Moeda" icon="🚀" active={active==='deploy'} onClick={() => setActive('deploy')} />
                <NavItem label="Bank Connect" icon="🏦" active={active==='bank'} onClick={() => setActive('bank')} />
                <a href="/setup" className="flex items-center w-full px-3 py-2 rounded-lg text-sm transition shadow-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100/70 dark:hover:bg-slate-800/50"><span className="mr-2">🔗</span>Account Setup</a>
              </div>
              {notice && (
                <div className="mt-4 p-3 rounded-lg text-sm border border-blue-200/60 bg-blue-50/70 text-blue-800 dark:text-blue-200 dark:bg-blue-900/20 dark:border-blue-800">{notice}</div>
              )}
            </aside>

            <main className="col-span-12 md:col-span-9 lg:col-span-10 space-y-6">
              {active === 'dashboard' && <Dashboard />}
              {active === 'deploy' && <DeployToken onNotice={setNotice} />}
              {active === 'bank' && <BankConnect onNotice={setNotice} />}
            </main>
          </div>
        </div>
      );
    }

    function Stat({label, value, sub}) {
      return (
        <div className="p-4 backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl shadow-sm">
          <div className="text-xs uppercase text-slate-500 dark:text-slate-400">{label}</div>
          <div className="text-xl font-semibold text-slate-900 dark:text-slate-100 mt-1">{value}</div>
          {sub && <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">{sub}</div>}
        </div>
      );
    }

    function Dashboard() {
      const [health, setHealth] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const load = async () => {
        setLoading(true); setError(null);
        try {
          const { data } = await axios.get('/health');
          setHealth(data);
        } catch (e) {
          setError(e?.response?.data?.error || e.message);
        } finally { setLoading(false); }
      };

      useEffect(() => { load(); }, []);

      return (
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <h2 className="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white drop-shadow-sm">Overview</h2>
            <button onClick={load} className="px-3 py-1.5 text-sm rounded-md bg-slate-900 text-white hover:bg-slate-800">Refresh</button>
          </div>

          {error && <div className="p-3 rounded-lg border border-red-200/60 bg-red-50/70 text-red-700 dark:bg-red-900/20 dark:text-red-200 dark:border-red-800 text-sm">{error}</div>}

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <Stat label="API" value={health ? 'Healthy' : (loading ? 'Loading…' : 'Unknown')} sub="/health" />
            <Stat label="WhatsApp" value={health?.services?.whatsapp ? 'Active' : 'Disabled'} />
            <Stat label="Pluggy" value={health?.services?.pluggy ? 'Active' : 'Disabled'} />
            <Stat label="Network" value={window.location.origin} />
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="p-5 backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl shadow-sm">
              <h3 className="font-medium text-slate-900 dark:text-slate-100">Quick Start</h3>
              <ol className="mt-3 text-sm text-slate-600 dark:text-slate-300 list-decimal list-inside space-y-1">
                <li>Deploy a token</li>
                <li>Connect a bank account</li>
                <li>Mint within bank backing limits</li>
              </ol>
            </div>

            <div className="p-5 backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl shadow-sm">
              <h3 className="font-medium text-slate-900 dark:text-slate-100">Helpful Links</h3>
              <ul className="mt-3 text-sm text-blue-700 dark:text-blue-300 space-y-1">
                <li><a className="hover:underline" href="/" target="_blank">Root</a></li>
                <li><a className="hover:underline" href="#" onClick={(e)=>{e.preventDefault(); alert('Docs coming soon');}}>Docs</a></li>
              </ul>
            </div>
          </div>
        </div>
      );
    }

    function DeployToken({ onNotice }) {
      const [form, setForm] = useState({ masterMinter: '', pauser: '', blacklister: '', owner: '' });
      const [submitting, setSubmitting] = useState(false);
      const [result, setResult] = useState(null);
      const [error, setError] = useState(null);
      const [connected, setConnected] = useState(!!window.CONNECTED_ADDRESS);
      const [nameFilled, setNameFilled] = useState(false);
      const [symbolFilled, setSymbolFilled] = useState(false);
      const [network, setNetwork] = useState('celoSepolia'); // 'celo' or 'celoSepolia'
      const nameRef = React.useRef(null);
      const symbolRef = React.useRef(null);

      const networkParams = {
        celo: {
          chainId: '0xa4ec',
          chainName: 'Celo Mainnet',
          nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
          rpcUrls: ['https://forno.celo.org', 'https://rpc.ankr.com/celo'],
          blockExplorerUrls: ['https://celoscan.io', 'https://explorer.celo.org/mainnet']
        },
        celoSepolia: {
          chainId: '0xaa044c', // 11142220
          chainName: 'Celo Sepolia Testnet',
          nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
          rpcUrls: ['https://forno.celo-sepolia.celo-testnet.org'],
          blockExplorerUrls: ['https://celo-sepolia.blockscout.com']
        }
      };

      async function ensureWalletOnNetwork(target) {
        try {
          if (!window.ethereum) return true; // nothing to switch; allow server-side deploy
          if (window.IS_SAFE_APP) return true; // Safe controls network externally
          const params = networkParams[target];
          if (!params) return true;
          // Try switch first
          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: params.chainId }] });
          return true;
        } catch (err) {
          // If unknown chain, try to add it then switch
          if (err && (err.code === 4902 || err.code === -32603)) {
            try {
              const params = networkParams[target];
              await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [params] });
              await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: params.chainId }] });
              return true;
            } catch (e2) {
              setError(e2?.message || 'Failed to add/switch network');
              return false;
            }
          }
          setError(err?.message || 'Failed to switch network');
          return false;
        }
      }

      // Minimal ABI for TokenFactory.deployToken + event we need to parse
      const TokenFactoryABI = [
        {
          "inputs": [
            { "internalType": "string", "name": "name", "type": "string" },
            { "internalType": "string", "name": "symbol", "type": "string" },
            { "internalType": "address", "name": "masterMinter", "type": "address" },
            { "internalType": "address", "name": "pauser", "type": "address" },
            { "internalType": "address", "name": "blacklister", "type": "address" },
            { "internalType": "address", "name": "owner", "type": "address" }
          ],
          "name": "deployToken",
          "outputs": [
            { "internalType": "address", "name": "tokenProxy", "type": "address" },
            { "internalType": "address", "name": "implementation", "type": "address" }
          ],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "anonymous": false,
          "inputs": [
            { "indexed": true, "internalType": "address", "name": "token", "type": "address" },
            { "indexed": true, "internalType": "address", "name": "proxy", "type": "address" },
            { "indexed": true, "internalType": "address", "name": "deployer", "type": "address" },
            { "indexed": false, "internalType": "string", "name": "name", "type": "string" },
            { "indexed": false, "internalType": "string", "name": "symbol", "type": "string" }
          ],
          "name": "TokenDeployed",
          "type": "event"
        }
      ];

      async function deployOnchain(name, symbol, roles) {
        if (!window.ethereum || !window.ethers) throw new Error('No wallet available');
        const factoryAddr = network === 'celo' ? (window.CELO_FACTORY_ADDRESS || '') : (window.CELO_SEPOLIA_FACTORY_ADDRESS || '');
        if (!factoryAddr) throw new Error('Factory address not configured for selected network');

        const provider = new window.ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const factory = new window.ethers.Contract(factoryAddr, TokenFactoryABI, signer);
        const tx = await factory.deployToken(name, symbol, roles.masterMinter, roles.pauser, roles.blacklister, roles.owner);
        const receipt = await tx.wait();
        const iface = new window.ethers.Interface(TokenFactoryABI);
        let proxy, implementation;
        for (const log of receipt.logs || []) {
          try {
            const parsed = iface.parseLog(log);
            if (parsed && parsed.name === 'TokenDeployed') {
              proxy = parsed.args.token;
              implementation = parsed.args.proxy;
              break;
            }
          } catch (_) {}
        }
        return {
          proxy: proxy || (receipt.logs?.[0]?.address || null),
          implementation: implementation || null,
          txHash: receipt.hash,
          gasUsed: receipt.gasUsed?.toString?.() || '0'
        };
      }

      // Read backing from BankOracle and supply from ERC20
      const BankOracleABI = [
        { "inputs": [{"internalType":"address","name":"token","type":"address"}], "name": "getBalance", "outputs": [{"internalType":"uint256","name":"","type":"uint256"}], "stateMutability": "view", "type": "function" }
      ];
      const ERC20ABI = [
        { "inputs": [], "name": "totalSupply", "outputs": [{"internalType":"uint256","name":"","type":"uint256"}], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "decimals", "outputs": [{"internalType":"uint8","name":"","type":"uint8"}], "stateMutability": "view", "type": "function" }
      ];

      async function loadBacking(tokenAddr) {
        if (!window.ethers || !window.ORACLE_ADDRESS || !tokenAddr) return null;
        try {
          const provider = new window.ethers.BrowserProvider(window.ethereum);
          const oracle = new window.ethers.Contract(window.ORACLE_ADDRESS, BankOracleABI, provider);
          const token = new window.ethers.Contract(tokenAddr, ERC20ABI, provider);
          const [backingRaw, supplyRaw, dec] = await Promise.all([
            oracle.getBalance(tokenAddr),
            token.totalSupply(),
            token.decimals()
          ]);
          const scale = window.ethers.toNumber(dec);
          const backing = Number(backingRaw) / 10 ** 2; // oracle stores cents for BRL/USD style
          const supply = Number(supplyRaw) / 10 ** scale;
          const ratio = supply > 0 ? (backing / supply) : null;
          return { backing, supply, ratio };
        } catch (e) { return null; }
      }

      // Prefill roles when a wallet connection changes
      useEffect(() => {
        const handler = (e) => {
          const addr = e?.detail?.address;
          setConnected(!!addr);
          if (addr) setForm((prev) => ({ ...prev, masterMinter: addr, pauser: addr, blacklister: addr, owner: addr }));
        };
        window.addEventListener('wallet:changed', handler);
        if (window.CONNECTED_ADDRESS) handler({ detail: { address: window.CONNECTED_ADDRESS } });
        return () => window.removeEventListener('wallet:changed', handler);
      }, []);

      const submit = async (e) => {
        e.preventDefault(); setSubmitting(true); setError(null); setResult(null);
        try {
          if (!window.ethereum) { throw new Error('Connect your wallet first'); }
          // Require wallet on selected network
          const ok = await ensureWalletOnNetwork(network);
          if (!ok) { setSubmitting(false); return; }
          const name = nameRef.current?.value || '';
          const symbol = symbolRef.current?.value || '';
          const roles = { ...form };
          const factoryAddr = network === 'celo' ? (window.CELO_FACTORY_ADDRESS || '') : (window.CELO_SEPOLIA_FACTORY_ADDRESS || '');
          if (!factoryAddr) {
            throw new Error('Factory address not configured for selected network');
          }
          const res = await deployOnchain(name, symbol, roles);
          setResult(res);
          // load backing after deploy
          try { res.backing = await loadBacking(res.proxy); } catch (_) {}
          // Prompt wallet to watch the newly deployed asset
          try {
            if (window.ethereum && res.proxy) {
              await window.ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                  type: 'ERC20',
                  options: {
                    address: res.proxy,
                    symbol: (symbol || '').slice(0, 11) || 'TOKEN',
                    decimals: 6,
                    image: undefined
                  }
                }
              });
            }
          } catch (_) {}
          // Deployment success notice (auto-dismissed by App)
          onNotice?.('On-chain deployment sent and confirmed.');
        } catch (err) {
          setError(err?.response?.data?.error || err.message);
        } finally { setSubmitting(false); }
      };

      const connectBank = async () => {
        try {
          const { data } = await axios.post(`/api/connect-bank/${result.proxy}`, { network });
          if (data?.connectUrl) window.open(data.connectUrl, '_blank');
        } catch (err) {
          alert(err?.response?.data?.error || err.message);
        }
      };

      const Field = ({ label, name, placeholder }) => (
        <div>
          <label className="block text-sm text-slate-600 dark:text-slate-300 mb-1">{label}</label>
          <input
            type="text"
            autoComplete="off"
            onChange={(e)=>setForm((prev) => ({ ...prev, [name]: e.target.value }))}
            placeholder={placeholder}
            value={form[name] || ''}
            className="w-full rounded-md px-3 py-2 text-sm border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
      );

      return (
        <div className="space-y-4">
          <h2 className="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white drop-shadow-sm">make a new moeda</h2>
          <form onSubmit={submit} className="backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl p-5 space-y-4 shadow-sm">
            <div className="rounded-md p-3 text-sm border border-amber-200/60 bg-amber-50/70 text-amber-800 dark:text-amber-200 dark:bg-amber-900/20 dark:border-amber-800">
              Connect your multisig (Safe) wallet to create the community currency. If you connect a personal wallet instead for deployment, paste your multisig address into the role fields below so the multisig controls the token.
            </div>
            <div className="flex items-center gap-2 text-xs">
              <span className="text-slate-600 dark:text-slate-300">Select Network:</span>
              <button type="button" onClick={async()=>{ setNetwork('celoSepolia'); await ensureWalletOnNetwork('celoSepolia'); }} className={`px-2 py-1 rounded border ${network==='celoSepolia' ? 'bg-emerald-600 text-white border-emerald-700' : 'bg-white/70 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-slate-300 dark:border-slate-700'}`}>Celo Testnet (Sepolia)</button>
              <button type="button" onClick={async()=>{ setNetwork('celo'); await ensureWalletOnNetwork('celo'); }} className={`px-2 py-1 rounded border ${network==='celo' ? 'bg-emerald-600 text-white border-emerald-700' : 'bg-white/70 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-slate-300 dark:border-slate-700'}`}>Celo Mainnet</button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm text-slate-600 dark:text-slate-300 mb-1">Token Name</label>
                <input ref={nameRef} type="text" autoComplete="off" placeholder="Community Real" onInput={(e)=>setNameFilled(!!e.target.value.trim())}
                       className="w-full rounded-md px-3 py-2 text-sm border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label className="block text-sm text-slate-600 dark:text-slate-300 mb-1">Symbol</label>
                <input ref={symbolRef} type="text" autoComplete="off" placeholder="CREAL" onInput={(e)=>setSymbolFilled(!!e.target.value.trim())}
                       className="w-full rounded-md px-3 py-2 text-sm border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <Field label="Master Minter (multisig)" name="masterMinter" placeholder="0x multisig address" />
              <Field label="Pauser (multisig)" name="pauser" placeholder="0x multisig address" />
              <Field label="Blacklister (multisig)" name="blacklister" placeholder="0x multisig address" />
              <Field label="Owner (multisig)" name="owner" placeholder="0x multisig address" />
            </div>
            
            <div className="flex items-center gap-3">
              <button disabled={submitting || !connected || !nameFilled || !symbolFilled}
                      title={!connected ? 'Connect wallet' : (!nameFilled ? 'Enter token name' : (!symbolFilled ? 'Enter token symbol' : ''))}
                      className="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-emerald-500 text-white text-sm hover:opacity-95 disabled:opacity-50 shadow">
                {submitting ? 'Making…' : 'Make Moeda'}
              </button>
              {error && <span className="text-sm text-red-600 dark:text-red-300">{error}</span>}
            </div>
          </form>

          {result && (
            <div className="backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl p-5 shadow-sm">
              <h3 className="font-medium text-slate-900 mb-2">Moeda Created</h3>
              <div className="text-sm text-slate-700 dark:text-slate-200 space-y-1">
                <div><span className="text-slate-500 dark:text-slate-400">Stablecoin (Token Address):</span> {result.proxy}</div>
                <div><span className="text-slate-500 dark:text-slate-400">Implementation (legacy):</span> {result.implementation}</div>
                <div><span className="text-slate-500 dark:text-slate-400">Transaction Hash:</span> {result.txHash}</div>
                {window.ORACLE_ADDRESS && (
                  <div className="mt-2">
                    <button onClick={async()=>{ const b = await loadBacking(result.proxy); setResult(prev => ({...prev, backing: b})); }} className="px-2 py-1 text-xs rounded bg-slate-200 dark:bg-slate-700">Refresh Backing</button>
                    {result.backing && (
                      <div className="mt-2 text-xs text-slate-600 dark:text-slate-300">
                        Backing: {result.backing.backing?.toLocaleString?.() ?? '-'} | Supply: {result.backing.supply?.toLocaleString?.() ?? '-'} | Ratio: {result.backing.ratio ? (result.backing.ratio*100).toFixed(2)+'%' : '-'}
                      </div>
                    )}
                  </div>
                )}
              </div>
              <button onClick={connectBank} className="mt-4 px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700 shadow">Connect Bank Account</button>
            </div>
          )}
        </div>
      );
    }

    function BankConnect({ onNotice }) {
      const [address, setAddress] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [url, setUrl] = useState(null);

      const submit = async (e) => {
        e.preventDefault(); setLoading(true); setError(null); setUrl(null);
        try {
          const { data } = await axios.post(`/api/connect-bank/${address}`);
          setUrl(data.connectUrl); onNotice?.('Connection created. Complete it in Pluggy.');
        } catch (err) {
          setError(err?.response?.data?.error || err.message);
        } finally { setLoading(false); }
      };

      return (
        <div className="space-y-6">
          <h2 className="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white drop-shadow-sm">Bank Connect</h2>
          <form onSubmit={submit} className="backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl p-5 space-y-4 shadow-sm">
            <div>
              <label className="block text-sm text-slate-600 dark:text-slate-300 mb-1">Token Address</label>
              <input value={address} onChange={(e)=>setAddress(e.target.value)} placeholder="0x..."
                     className="w-full rounded-md px-3 py-2 text-sm border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="flex items-center gap-3">
              <button disabled={loading} className="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-emerald-500 text-white text-sm hover:opacity-95 disabled:opacity-50 shadow">{loading ? 'Creating…' : 'Create Connection'}</button>
              {error && <span className="text-sm text-red-600 dark:text-red-300">{error}</span>}
            </div>
          </form>

          {url && (
            <div className="backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl p-5 shadow-sm">
              <div className="text-sm text-slate-700 dark:text-slate-200">Open this link to complete connection:</div>
              <a href={url} target="_blank" className="text-blue-700 dark:text-blue-300 hover:underline break-all">{url}</a>
            </div>
          )}

          {/* PIX deposit → auto‑mint and redeem panel */}
          <div className="backdrop-blur bg-white/70 dark:bg-slate-900/50 border border-white/40 dark:border-slate-800 rounded-xl p-5 shadow-sm">
            <PixActions initialTokenAddress={address} />
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function PixActions({ initialTokenAddress='' }) {
      const [tokenAddress, setTokenAddress] = useState(initialTokenAddress || '');
      const [pixKey, setPixKey] = useState('');
      const [redeemPixKey, setRedeemPixKey] = useState('');
      const [redeemAmount, setRedeemAmount] = useState('');
      const [wallet, setWallet] = useState(window.CONNECTED_ADDRESS || '');
      const [status, setStatus] = useState('');

      useEffect(() => {
        function onWalletChanged(e){ setWallet((e?.detail?.address) || ''); }
        window.addEventListener('wallet:changed', onWalletChanged);
        return () => window.removeEventListener('wallet:changed', onWalletChanged);
      }, []);

      useEffect(() => { if (initialTokenAddress) setTokenAddress(initialTokenAddress); }, [initialTokenAddress]);

      async function linkPix() {
        try {
          if (!/^0x[a-fA-F0-9]{40}$/.test(tokenAddress)) throw new Error('Provide a valid token address');
          if (!pixKey) throw new Error('Enter your PIX key');
          if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) throw new Error('Connect a wallet first');
          await axios.post('/api/pix/link', { tokenAddress, pixKey, wallet });
          setStatus('PIX key linked. Deposits to the connected bank account will auto‑mint to your wallet.');
        } catch (e) {
          setStatus(`Link failed: ${e?.response?.data?.error || e.message}`);
        }
      }

      async function redeem() {
        try {
          if (!/^0x[a-fA-F0-9]{40}$/.test(tokenAddress)) throw new Error('Provide a valid token address');
          if (!redeemPixKey) throw new Error('Enter destination PIX key');
          if (!redeemAmount || Number(redeemAmount) <= 0) throw new Error('Enter redeem amount');
          await axios.post(`/api/tokens/${tokenAddress}/redeem`, { pixKey: redeemPixKey, amount: redeemAmount });
          setStatus('Redemption initiated. After PIX is sent, tokens are burned.');
        } catch (e) {
          setStatus(`Redeem failed: ${e?.response?.data?.error || e.message}`);
        }
      }

      return (
        <div className="max-w-2xl mx-auto mt-8 p-6 rounded-xl shadow-lg bg-white/70 dark:bg-slate-800/60 backdrop-blur">
          <h2 className="text-xl font-semibold mb-4">PIX Deposit → Auto‑Mint, and Redeem → BRL</h2>

          <label className="block text-sm mb-1">Token Address</label>
          <input value={tokenAddress} onChange={e=>setTokenAddress(e.target.value)} placeholder="0x..."
                 className="w-full p-2 border rounded mb-3 text-slate-900" />

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h3 className="font-medium mb-2">Link PIX to Your Wallet</h3>
              <input value={pixKey} onChange={e=>setPixKey(e.target.value)} placeholder="Your PIX key"
                     className="w-full p-2 border rounded mb-2 text-slate-900" />
              <button onClick={linkPix} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded">
                Link PIX → Auto‑Mint
              </button>
              <p className="text-xs mt-2 opacity-80">
                After linking, deposits to the token’s connected bank account that reference your PIX key
                will be auto‑minted (admin mints then transfers) to your connected wallet.
              </p>
            </div>

            <div>
              <h3 className="font-medium mb-2">Redeem Tokens to BRL</h3>
              <input value={redeemPixKey} onChange={e=>setRedeemPixKey(e.target.value)} placeholder="PIX key to receive BRL"
                     className="w-full p-2 border rounded mb-2 text-slate-900" />
              <input type="number" value={redeemAmount} onChange={e=>setRedeemAmount(e.target.value)} placeholder="Amount"
                     className="w-full p-2 border rounded mb-2 text-slate-900" />
              <button onClick={redeem} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">
                Redeem → Send BRL via PIX
              </button>
              <p className="text-xs mt-2 opacity-80">
                Transfer tokens to the redemption wallet if prompted. Backend sends PIX then burns tokens.
              </p>
            </div>
          </div>

          <div className="mt-3 text-sm min-h-[1.5rem]">{status}</div>
        </div>
      );
    }

    // PixActions is now used inside the top menu below
  </script>

  <!-- Side menu: Dashboard, 🚀 Make Moeda, 🏦 Bank Connect -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    function MakeMoeda() {
      const [name, setName] = useState('');
      const [symbol, setSymbol] = useState('');
      const [result, setResult] = useState(null);
      const [connectUrl, setConnectUrl] = useState('');
      const wallet = window.CONNECTED_ADDRESS || '';

      async function deploy() {
        try {
          if (!wallet) throw new Error('Connect a wallet first');
          const body = {
            name, symbol,
            masterMinter: wallet, pauser: wallet, blacklister: wallet, owner: wallet
          };
          const res = await axios.post('/api/deploy-token', body);
          setResult(res.data);
          // connect Pluggy for this token
          const conn = await axios.post(`/api/connect-bank/${res.data.proxy}`);
          setConnectUrl(conn.data.connectUrl);
        } catch (e) {
          alert(e?.response?.data?.error || e.message);
        }
      }

      return (
        <div className="space-y-3">
          <input className="w-full p-2 border rounded text-slate-900" placeholder="Token Name" value={name} onChange={e=>setName(e.target.value)} />
          <input className="w-full p-2 border rounded text-slate-900" placeholder="Symbol" value={symbol} onChange={e=>setSymbol(e.target.value)} />
          <button onClick={deploy} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Deploy Token</button>
          {result && (
            <div className="p-3 bg-slate-100 dark:bg-slate-700 rounded">
              <div>Token: <code>{result.proxy}</code></div>
              {connectUrl && <a className="text-blue-600" href={connectUrl} target="_blank" rel="noreferrer">Connect Bank Account</a>}
            </div>
          )}
        </div>
      );
    }

    function MenuApp() {
      const [tab, setTab] = useState('dashboard');
      useEffect(() => {
        const fromHash = (location.hash || '').replace('#','');
        if (fromHash === 'make' || fromHash === 'bank' || fromHash === 'dashboard') {
          setTab(fromHash);
        }
        const onHash = () => {
          const h = (location.hash || '').replace('#','');
          if (h) setTab(h);
        };
        window.addEventListener('hashchange', onHash);
        return () => window.removeEventListener('hashchange', onHash);
      }, []);
      const tabs = [
        { id: 'dashboard', label: 'Dashboard', icon: '🏠' },
        { id: 'make', label: 'Make Moeda', icon: '🚀' },
        { id: 'bank', label: 'Bank Connect', icon: '🏦' },
      ];
      return (
        <div className="max-w-6xl mx-auto mt-6 grid grid-cols-12 gap-6">
          <aside className="col-span-12 md:col-span-3">
            <div className="p-3 rounded-2xl bg-slate-900/5 dark:bg-slate-800/80">
              <div className="flex flex-col gap-2">
                {tabs.map(t => (
                  <button
                    key={t.id}
                    onClick={() => { setTab(t.id); location.hash = t.id; }}
                    className={(tab===t.id
                      ? 'bg-indigo-600 text-white shadow'
                      : 'bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-slate-100 hover:bg-slate-200 dark:hover:bg-slate-600')
                      + ' px-4 py-3 rounded-xl text-left flex items-center gap-3 transition'}>
                    <span className="text-lg">{t.icon}</span>
                    <span className="font-medium">{t.label}</span>
                  </button>
                ))}
              </div>
            </div>
          </aside>

          <main className="col-span-12 md:col-span-9">
            {tab==='dashboard' && (
              <div className="p-5 rounded-2xl bg-white/70 dark:bg-slate-800/60 backdrop-blur">
                <h2 className="text-lg font-semibold mb-2">Dashboard</h2>
                <p className="opacity-80">Overview coming soon. Use Make Moeda to deploy a token or Bank Connect to link your PIX and redeem.</p>
              </div>
            )}
            {tab==='make' && (
              <div className="p-5 rounded-2xl bg-white/70 dark:bg-slate-800/60 backdrop-blur">
                <h2 className="text-lg font-semibold mb-3">🚀 Make Moeda</h2>
                <MakeMoeda />
              </div>
            )}
            {tab==='bank' && (
              <div className="p-5 rounded-2xl bg-white/70 dark:bg-slate-800/60 backdrop-blur">
                <h2 className="text-lg font-semibold mb-3">🏦 Bank Connect</h2>
                <PixActions />
              </div>
            )}
          </main>
        </div>
      );
    }

    const appEl = document.getElementById('app-menu');
    if (appEl) ReactDOM.createRoot(appEl).render(React.createElement(MenuApp));
  </script>
</body>
</html>
